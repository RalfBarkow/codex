#!/usr/bin/env bash
set -euo pipefail

if [ -z "${OPENAI_API_KEY-}" ] && [ -f "$HOME/.secrets/open-ai-api-key.txt" ]; then
  export OPENAI_API_KEY="$(tr -d ' \n\r\t' < "$HOME/.secrets/open-ai-api-key.txt")"
fi
if [ -z "${OPEN_API_KEY-}" ] && [ -n "${OPENAI_API_KEY-}" ]; then
  export OPEN_API_KEY="$OPENAI_API_KEY"
fi

prompt_source=""

usage() {
  cat <<'EOF'
Usage: codex-batch-bridge [-f prompt-file] [-- CODEX_EXEC_ARGS...]

- Provide a prompt via -f <file> or pipe text to stdin.
- Any arguments after -- are forwarded to `codex exec`.

Examples:
  echo "Summarise README" | codex-batch-bridge -- -C "$(pwd)"
  codex-batch-bridge -f prompt.md -- -m o4-mini --json
EOF
}

while [ $# -gt 0 ]; do
  case "$1" in
    -f|--file)
      if [ $# -lt 2 ]; then
        echo "Missing argument for $1" >&2
        exit 64
      fi
      prompt_source="$2"
      shift 2
      ;;
    -h|--help)
      usage
      exit 0
      ;;
    --)
      shift
      break
      ;;
    -*)
      echo "Unknown option: $1" >&2
      exit 64
      ;;
    *)
      # Treat first non-option as start of forwarded args
      break
      ;;
  esac
done

codex_args=("$@")

if [ -n "$prompt_source" ]; then
  if [ ! -f "$prompt_source" ]; then
    echo "Prompt file not found: $prompt_source" >&2
    exit 66
  fi
  exec codex exec "${codex_args[@]}" - <"$prompt_source"
else
  if [ -t 0 ]; then
    usage >&2
    exit 64
  fi
  exec codex exec "${codex_args[@]}" -
fi
